// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum Role {
  ADMIN
  MAHASISWA
  DOSEN
  LABORAN
}

enum ChemicalForm {
  SOLID
  LIQUID
  GAS
}

enum BorrowingStatus {
  PENDING
  APPROVED
  REJECTED
  RETURNED
  OVERDUE
}

model User {
  id            String     @id @default(nanoid()) @db.VarChar(255)
  username      String     @unique @db.VarChar(255)
  email         String     @unique @db.VarChar(255)
  password      String     @db.VarChar(255)
  role          Role       @default(MAHASISWA)
  status        UserStatus @default(ACTIVE)
  refresh_token String?
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt

  // Relations
  admin            Admin?
  mahasiswa        Mahasiswa?
  dosen            Dosen?
  laboran          Laboran?
  borrowings       Borrowing[]
  reports          Report[]
  createdChemicals Chemical[]  @relation("CreatedBy")
  updatedChemicals Chemical[]  @relation("UpdatedBy")

  @@index([username, email])
  @@map("users")
}

model Admin {
  pin     String @id @db.Char(5)
  user_id String @unique @db.VarChar(255)
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("admin")
}

model Mahasiswa {
  nim       String @id @db.Char(8)
  full_name String @db.VarChar(255)
  user_id   String @unique @db.VarChar(255)
  user      User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("mahasiswa")
}

model Dosen {
  nidn      String @id @db.Char(10)
  full_name String @db.VarChar(255)
  user_id   String @unique @db.VarChar(255)
  user      User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("dosen")
}

model Laboran {
  nip       String @id @db.Char(10)
  full_name String @db.VarChar(255)
  user_id   String @unique @db.VarChar(255)
  user      User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("laboran")
}

model Chemical {
  id             String       @id @default(nanoid())
  name           String       @db.VarChar(255)
  formula        String?      @db.VarChar(100)
  casNumber      String?      @map("cas_number") @db.VarChar(50)
  form           ChemicalForm
  stock          Int
  unit           String       @db.VarChar(20)
  purchaseDate   DateTime     @map("purchase_date")
  expirationDate DateTime?    @map("expiration_date")
  location       String       @db.VarChar(255)
  cabinet        String?      @db.VarChar(100)
  room           String?      @db.VarChar(100)
  temperature    String?      @db.VarChar(50)
  qrCode         String?      @unique @map("qr_code") @db.VarChar(255)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  createdBy   User    @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String  @map("created_by_id") @db.VarChar(255)
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String? @map("updated_by_id") @db.VarChar(255)

  borrowings   BorrowingItem[]
  usageHistory UsageHistory[]
  sds          SDS?

  @@map("chemicals")
}

model SDS {
  id          String   @id @default(nanoid())
  chemicalId  String   @unique @map("chemical_id")
  fileName    String?  @map("file_name") @db.VarChar(255)
  filePath    String?  @map("file_path") @db.VarChar(500)
  externalUrl String?  @map("external_url") @db.VarChar(500)
  uploadedAt  DateTime @default(now()) @map("uploaded_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  chemical Chemical @relation(fields: [chemicalId], references: [id], onDelete: Cascade)

  @@map("sds")
}

model Borrowing {
  id          String          @id @default(nanoid())
  borrowerId  String          @map("borrower_id") @db.VarChar(255)
  purpose     String          @db.Text
  status      BorrowingStatus @default(PENDING)
  requestDate DateTime        @default(now()) @map("request_date")
  approvedAt  DateTime?       @map("approved_at")
  returnedAt  DateTime?       @map("returned_at")
  notes       String?         @db.Text
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  borrower User            @relation(fields: [borrowerId], references: [id])
  items    BorrowingItem[]

  @@map("borrowings")
}

model BorrowingItem {
  id          String   @id @default(nanoid())
  borrowingId String   @map("borrowing_id")
  chemicalId  String   @map("chemical_id")
  quantity    Float
  returned    Boolean  @default(false)
  returnedQty Float?   @map("returned_qty")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  borrowing Borrowing @relation(fields: [borrowingId], references: [id], onDelete: Cascade)
  chemical  Chemical  @relation(fields: [chemicalId], references: [id])

  @@map("borrowing_items")
}

model UsageHistory {
  id         String   @id @default(nanoid())
  chemicalId String   @map("chemical_id")
  quantity   Float
  purpose    String   @db.Text
  usedAt     DateTime @default(now()) @map("used_at")
  userId     String?  @map("user_id") @db.VarChar(255)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  chemical Chemical @relation(fields: [chemicalId], references: [id])

  @@map("usage_history")
}

model Report {
  id          String   @id @default(nanoid())
  title       String   @db.VarChar(255)
  description String?  @db.Text
  type        String   @db.VarChar(100)
  data        Json
  createdBy   String   @map("created_by") @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  creator User @relation(fields: [createdBy], references: [id])

  @@map("reports")
}
