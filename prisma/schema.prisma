// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum Role {
  PETUGAS_GUDANG
  ADMIN
  MAHASISWA
  DOSEN
  LABORAN
}

enum ChemicalForm {
  SOLID
  LIQUID
  GAS
}

enum ChemicalCharacteristic {
  ACID
  BASE
  GENERAL
  OXIDANT
}

enum BorrowingStatus {
  PENDING
  APPROVED
  REJECTED
  RETURNED
  OVERDUE
}

model Device {
  id          String   @id @default(nanoid()) @db.VarChar(255)
  browserName String   @map("browser_name") @db.VarChar(255)
  deviceType  String   @map("device_type") @db.VarChar(255)
  deviceMerk  String   @map("device_merk") @db.VarChar(255)
  fcmToken    String   @map("fcm_token")
  lastUsed    DateTime @updatedAt

  // relation
  userId String @map("user_id") @db.VarChar(255)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("devices")
}

model User {
  id            String     @id @default(nanoid()) @db.VarChar(255)
  username      String     @unique @db.VarChar(255)
  email         String     @unique @db.VarChar(255)
  password      String     @db.VarChar(255)
  role          Role       @default(MAHASISWA)
  status        UserStatus @default(ACTIVE)
  refresh_token String?
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt

  // Relations
  admin                Admin?
  mahasiswa            Mahasiswa?
  dosen                Dosen?
  laboran              Laboran?
  devices              Device[]
  borrowings           Borrowing[]
  reports              Report[]
  createdChemicals     Chemical[]        @relation("CreatedBy")
  updatedChemicals     Chemical[]        @relation("UpdatedBy")
  createdSDS           SafetyDataSheet[] @relation("CreatedBy")
  updatedSDS           SafetyDataSheet[] @relation("UpdatedBy")
  approvedBorrowing    Borrowing[]       @relation("approvedBy")
  rejectedBorrowing    Borrowing[]       @relation("rejectedBy")
  returnedBorrowing    Borrowing[]       @relation("returnedBy")
  createdStockMutation stockMutation[]   @relation("CreatedBy")
  updatedStockMutation stockMutation[]   @relation("UpdatedBy")

  @@index([username, email, status, role])
  @@map("users")
}

model Admin {
  pin     String @id @db.Char(5)
  user_id String @unique @db.VarChar(255)
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("admin")
}

model Mahasiswa {
  nim       String @id @db.Char(8)
  full_name String @db.VarChar(255)
  user_id   String @unique @db.VarChar(255)
  user      User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("mahasiswa")
}

model Dosen {
  nidn      String @id @db.Char(10)
  full_name String @db.VarChar(255)
  user_id   String @unique @db.VarChar(255)
  user      User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("dosen")
}

model Laboran {
  nip       String @id @db.Char(10)
  full_name String @db.VarChar(255)
  user_id   String @unique @db.VarChar(255)
  user      User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("laboran")
}

model Chemical {
  id             String                 @id @default(nanoid()) @db.VarChar(255)
  name           String                 @unique @db.VarChar(255) // Nama bahan kimia
  formula        String?                @db.VarChar(255) // Rumus kimia (contoh: H2O, NaCl)
  form           ChemicalForm // Bentuk fisik bahan (contoh: padat, cair, gas)
  characteristic ChemicalCharacteristic // Karakteristik bahan (contoh: asam, basa, oksidator, umum)
  initialStock   Int                    @default(0) @map("initial_stock") // Jumlah stok bahan yang tersedia
  currentStock   Int                    @default(0) @map("current_stock") // Jumlah stok bahan saat ini
  unit           String                 @db.VarChar(20) // Satuan stok (contoh: gram, liter, botol)
  purchaseDate   DateTime               @map("purchase_date") // Tanggal pembelian bahan
  expirationDate DateTime?              @map("expiration_date") // Tanggal kadaluarsa (jika ada)
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")

  // Relations
  createdBy   User    @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String  @map("created_by_id") @db.VarChar(255)
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String? @map("updated_by_id") @db.VarChar(255)

  safetyDataSheet SafetyDataSheet?
  borrowings      BorrowingItem[]
  usageHistory    UsageHistory[]
  stockMutation   stockMutation[]

  @@index([name, formula, form, characteristic, expirationDate])
  @@map("chemicals")
}

model stockMutation {
  id          String   @id @default(nanoid()) @db.VarChar(255)
  quantity    Int // Jumlah perubahan stok (positif untuk penambahan, negatif untuk pengurangan)
  description String?  @db.Text // Deskripsi perubahan stok
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  chemicalId  String   @map("chemical_id") @db.VarChar(255)
  chemical    Chemical @relation(fields: [chemicalId], references: [id], onDelete: Cascade)
  createdById String   @map("created_by_id") @db.VarChar(255)
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById String?  @map("updated_by_id") @db.VarChar(255)
  updatedBy   User?    @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@index([chemicalId])
  @@map("stock_mutations")
}

model SafetyDataSheet {
  id          String  @id @default(nanoid()) @db.VarChar(255)
  fileName    String? @map("file_name") @db.VarChar(255)
  filePath    String? @map("file_path") @db.VarChar(500)
  externalUrl String? @map("external_url") @db.VarChar(500)
  language    String  @db.VarChar(255)

  // Relations
  chemical    Chemical @relation(fields: [chemicalId], references: [id], onDelete: Cascade)
  chemicalId  String   @unique @map("chemical_id")
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String   @map("created_by_id") @db.VarChar(255)
  updatedBy   User?    @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?  @map("updated_by_id") @db.VarChar(255)

  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  SDSDownloadHistory SDSDownloadHistory[]

  @@index([chemicalId, language])
  @@map("safety_data_sheets")
}

model SDSDownloadHistory {
  id             String          @id @default(nanoid()) @db.VarChar(255)
  sdsId          String          @map("sds_id") @db.VarChar(255)
  sds            SafetyDataSheet @relation(fields: [sdsId], references: [id])
  downloadedAt   DateTime        @default(now()) @map("downloaded_at")
  downloadedById String?         @map("downloaded_by_id") @db.VarChar(255)

  @@index([sdsId])
  @@index([downloadedAt])
  @@map("sds_download_history")
}

enum SarjanaLevel {
  S1
  S2
  S3
}

model Borrowing {
  id           String          @id @default(nanoid()) @db.VarChar(255)
  purpose      String          @db.Text
  sarjanaLevel SarjanaLevel?   @map("sarjana_level")
  status       BorrowingStatus @default(PENDING)
  requestDate  DateTime        @default(now()) @map("request_date")
  approvedAt   DateTime?       @map("approved_at")
  rejectedAt   DateTime?       @map("rejected_at")
  returnedAt   DateTime?       @map("returned_at")
  notes        String?         @db.Text
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  approvedById String? @map("approved_by_id") @db.VarChar(255)
  approvedBy   User?   @relation("approvedBy", fields: [approvedById], references: [id])
  rejectedById String? @map("rejected_by_id") @db.VarChar(255)
  rejectedBy   User?   @relation("rejectedBy", fields: [rejectedById], references: [id])
  returnedById String? @map("returned_by_id") @db.VarChar(255)
  returnedBy   User?   @relation("returnedBy", fields: [returnedById], references: [id])

  borrowerId   String          @map("borrower_id") @db.VarChar(255)
  borrower     User            @relation(fields: [borrowerId], references: [id])
  items        BorrowingItem[]
  UsageHistory UsageHistory[]

  @@index([borrowerId, status])
  @@map("borrowings")
}

model BorrowingItem {
  id          String   @id @default(nanoid()) @db.VarChar(255)
  quantity    Float
  returned    Boolean  @default(false)
  returnedQty Float?   @map("returned_qty")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  borrowingId String    @map("borrowing_id")
  borrowing   Borrowing @relation(fields: [borrowingId], references: [id], onDelete: Cascade)
  chemicalId  String    @map("chemical_id")
  chemical    Chemical  @relation(fields: [chemicalId], references: [id])

  @@index([borrowingId, chemicalId])
  @@map("borrowing_items")
}

model UsageHistory {
  id        String   @id @default(nanoid()) @db.VarChar(255)
  quantity  Int
  purpose   String   @db.Text // Tujuan penggunaan bahan kimia
  usedAt    DateTime @default(now()) @map("used_at")
  userId    String?  @map("user_id") @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  borrowingId String?    @db.VarChar(255)
  borrowing   Borrowing? @relation(fields: [borrowingId], references: [id])
  chemicalId  String     @map("chemical_id")
  chemical    Chemical   @relation(fields: [chemicalId], references: [id])

  @@map("usage_history")
}

model Report {
  id          String     @id @default(nanoid()) @db.VarChar(255)
  title       String     @db.VarChar(255)
  description String?    @db.Text
  type        ReportType
  data        Json
  startDate   DateTime?  @map("start_date")
  endDate     DateTime?  @map("end_date")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  createdById String @map("created_by_id") @db.VarChar(255)
  createdBy   User   @relation(fields: [createdById], references: [id])

  @@map("reports")
}

enum ReportType {
  CHEMICAL
  SDS
  BORROWING
  MIXED
}
